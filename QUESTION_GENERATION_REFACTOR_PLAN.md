# План перехода к ленивой генерации вопросов с рандомизацией типа

## 1. Архитектура и состояние игры
- [x] Изменить структуру состояния игры:
  - [x] Вместо массива вопросов хранить только текущий вопрос, номер вопроса и историю.
  - [x] Добавить флаг "идёт генерация следующего вопроса" (для асинхронности).
  - _Комментарий: массив questions удалён, добавлен is_generating_question, обновлены методы next_question/next_round._
- [x] Обновить модели (`src/models/`):
  - [x] GameState, QuestionState, возможно, UserState.
  - _Комментарий: добавлено хранение истории вопросов (question_history) в GameState._

## 2. Логика генерации вопросов
- [x] Реализовать функцию генерации одного вопроса "on demand":
  - [x] При старте раунда генерировать только первый вопрос.
  - [x] После ответа — запускать генерацию следующего вопроса.
  - _Комментарий: генерация вопросов теперь происходит по одному, при необходимости._
- [x] Добавить рандомизацию типа вопроса:
  - [x] Для каждого нового вопроса случайно выбирать тип из доступных (с учётом темы/сложности).
  - [x] (Опционально) Реализовать веса для разных типов.
  - _Комментарий: реализована функция get_random_question_type, тип выбирается для каждого вопроса отдельно._

## 3. Асинхронная генерация и обработка ошибок
- [x] Генерировать следующий вопрос в фоне, пока игроки отвечают на текущий.
  - _Комментарий: реализован preload_next_question, вопрос генерируется асинхронно и используется при переходе._
- [ ] Если генерация не удалась — повторить попытку или выдать запасной вопрос.
- [x] Обновить обработчики перехода к следующему вопросу.
  - _Комментарий: добавлены проверки is_generating_question и сообщения пользователю в /next и next_round_callback._

## 4. Интерфейс и взаимодействие с игроками
- [x] Обновить обработчики команд и callback-ов:
  - [x] /next, /start, /stop, /exit и т.д.
  - [x] Переход к следующему вопросу только после генерации.
- [x] Добавить сообщения "Генерируется следующий вопрос..." если генерация занимает время.
  - _Комментарий: сообщения и проверки добавлены в основные обработчики._

## 5. Тестирование и обратная связь
- [ ] Покрыть новую логику тестами (юнит/интеграционными).
- [ ] Добавить debug-логи для отслеживания этапов генерации и выбора типа.
- [ ] Проверить работу с разными темами и типами вопросов.

## 6. Документация и миграция
- [ ] Описать изменения в README/CHANGELOG.
- [ ] Добавить инструкцию по миграции для старых игр (если требуется). 