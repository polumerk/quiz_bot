# 🏗️ Архитектура системы формирования вопросов Quiz Bot 2.0

## 📋 Обзор архитектуры

Quiz Bot 2.0 использует многослойную архитектуру с четким разделением ответственности между компонентами. Система построена на принципах:
- **Модульности** - каждый компонент выполняет определенную роль
- **Масштабируемости** - легко добавлять новые типы вопросов и источники
- **Надежности** - обработка ошибок и фолбэки на всех уровнях
- **Производительности** - эффективное кэширование и предотвращение дублирования

## 🎯 Основные компоненты системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           QUIZ BOT 2.0 ARCHITECTURE                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   TELEGRAM      │    │   HANDLERS      │    │   GAME LOGIC    │        │
│  │   INTERFACE     │────│   LAYER         │────│   LAYER         │        │
│  │                 │    │                 │    │                 │        │
│  │ • Commands      │    │ • Messages      │    │ • Round Control │        │
│  │ • Callbacks     │    │ • Callbacks     │    │ • Questions     │        │
│  │ • Updates       │    │ • Commands      │    │ • Scoring       │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                          │                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   MODELS &      │    │   QUESTION      │    │   DATA STORAGE  │        │
│  │   TYPES         │────│   GENERATION    │────│   LAYER         │        │
│  │                 │    │                 │    │                 │        │
│  │ • GameState     │    │ • OpenAI API    │    │ • SQLite DB     │        │
│  │ • Question      │    │ • Fuzzy Logic   │    │ • History Cache │        │
│  │ • Participant   │    │ • Validation    │    │ • Statistics    │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   UTILS &       │    │   ERROR         │    │   FORMATTERS    │        │
│  │   HELPERS       │────│   HANDLING      │────│   & DISPLAY     │        │
│  │                 │    │                 │    │                 │        │
│  │ • Config        │    │ • Safe Calls    │    │ • Round Results │        │
│  │ • Language      │    │ • Logging       │    │ • Individual    │        │
│  │ • Validation    │    │ • Fallbacks     │    │ • Team Results  │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных системы формирования вопросов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        QUESTION GENERATION FLOW                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. НАСТРОЙКА ИГРЫ                                                          │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   User Input    │───▶│   Settings      │───▶│   GameState     │        │
│  │                 │    │   Validation    │    │   Update        │        │
│  │ • Theme         │    │ • Difficulty    │    │ • Mode          │        │
│  │ • Difficulty    │    │ • Questions     │    │ • Rounds        │        │
│  │ • Mode          │    │ • Time limits   │    │ • Participants  │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                          │                  │
│  2. ГЕНЕРАЦИЯ ВОПРОСОВ                                   ▼                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   History       │───▶│   OpenAI API    │───▶│   Question      │        │
│  │   Check         │    │   Request       │    │   Objects       │        │
│  │                 │    │                 │    │                 │        │
│  │ • Theme History │    │ • Prompt Build  │    │ • Validation    │        │
│  │ • Duplicates    │    │ • Response      │    │ • Parsing       │        │
│  │ • Limits        │    │ • Error Handle  │    │ • Storage       │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                          │                  │
│  3. ИГРОВОЙ ПРОЦЕСС                                      ▼                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   Question      │───▶│   Answer        │───▶│   Result        │        │
│  │   Display       │    │   Processing    │    │   Evaluation    │        │
│  │                 │    │                 │    │                 │        │
│  │ • Format        │    │ • Fuzzy Match   │    │ • Scoring       │        │
│  │ • Timeout       │    │ • Validation    │    │ • Fast Bonus    │        │
│  │ • Reply Mode    │    │ • Team/Solo     │    │ • Statistics    │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                          │                  │
│  4. РЕЗУЛЬТАТЫ И СЛЕДУЮЩИЙ РАУНД                         ▼                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   Results       │───▶│   Statistics    │───▶│   Next Round    │        │
│  │   Formatting    │    │   Update        │    │   or End        │        │
│  │                 │    │                 │    │                 │        │
│  │ • Individual    │    │ • DB Storage    │    │ • Round++       │        │
│  │ • Team Mode     │    │ • User Stats    │    │ • Game End      │        │
│  │ • Ranking       │    │ • Game History  │    │ • Cleanup       │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧩 Детальный анализ компонентов

### 1. 📱 **Telegram Interface Layer**
```python
# Основные файлы:
- main.py              # Главный файл приложения
- src/handlers/        # Обработчики событий
  ├── commands.py      # Команды (/start, /help, etc.)
  ├── callbacks.py     # Inline кнопки
  └── messages.py      # Текстовые сообщения
```

**Функции:**
- 🎮 **Команды**: `/start`, `/help`, `/settings`
- 🔘 **Inline кнопки**: Настройки, управление игрой
- 📝 **Сообщения**: Ответы на вопросы через reply

### 2. 🎯 **Game Logic Layer**
```python
# Основные файлы:
- src/game/logic.py    # Игровая логика
```

**Ключевые функции:**
- `start_round()` - Запуск раунда с генерацией вопросов
- `ask_next_question()` - Показ следующего вопроса
- `question_timeout()` - Обработка таймаута
- `finish_round()` - Завершение раунда и подсчет

### 3. 🧠 **Question Generation System**
```python
# Основные файлы:
- questions.py         # Генерация вопросов через OpenAI
```

**Компоненты:**
- **OpenAI Integration**: Запросы к GPT-4o
- **History Prevention**: Предотвращение дублирования
- **Prompt Engineering**: Качественные промпты
- **Error Handling**: Обработка ошибок API

#### 🔧 **Промпт-инжиниринг**
```python
SYSTEM_PROMPT_QUESTION = (
    "Ты — AI-ведущий интеллектуального квиза. "
    "Генерируй только однозначные вопросы с коротким, точным ответом. "
    "Не добавляй лишних пояснений, соблюдай формат строго."
)
```

### 4. 🗃️ **Models & Data Layer**
```python
# Основные файлы:
- src/models/types.py      # Типы данных
- src/models/game_state.py # Игровое состояние
```

**Основные модели:**
- `GameState` - Состояние игры
- `Question` - Структура вопроса
- `Participant` - Участник игры
- `Answer` - Ответ пользователя

### 5. 🗄️ **Data Storage Layer**
```python
# Основные файлы:
- db.py               # База данных SQLite
```

**Таблицы:**
- `questions_history` - История вопросов
- `games` - Игровые сессии
- `users` - Пользователи и статистика
- `answers` - Ответы пользователей

### 6. 🎨 **Formatters & Display**
```python
# Основные файлы:
- src/utils/formatters.py # Форматирование результатов
```

**Функции форматирования:**
- `format_round_results_team()` - Командный режим
- `format_round_results_individual()` - Индивидуальный режим

## 🚀 Процесс генерации вопросов

### 1. **Запрос к OpenAI**
```python
async def openai_generate_questions(theme, round_num, chat_id, 
                                   get_difficulty, get_questions_per_round):
    # 1. Получение истории вопросов
    history_questions = get_questions_history(theme, limit=50)
    
    # 2. Построение промпта
    prompt = build_openai_prompt(theme, round_num, questions_per_round, 
                                history_text, difficulty)
    
    # 3. Запрос к GPT-4o
    data = {
        "model": "gpt-4o",
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT_QUESTION},
            {"role": "user", "content": prompt}
        ],
        "max_tokens": 1024,
        "temperature": 0.2
    }
    
    # 4. Обработка ответа и валидация
    # 5. Сохранение в историю
```

### 2. **Построение промпта**
```python
def build_openai_prompt(theme, round_num, questions_per_round, 
                       history_text, difficulty):
    return (
        START_PROMPT +
        f"\nТема: {theme}\n"
        f"Сгенерируй {questions_per_round} уникальных вопросов "
        f"для раунда {round_num}. "
        f"Все вопросы должны быть уровня сложности: {difficulty}. "
        "КРИТИЧЕСКИ ВАЖНО: каждый вопрос должен иметь "
        "ЕДИНСТВЕННЫЙ правильный ответ.\n"
        f"{history_text}"
    )
```

### 3. **Обработка ответов**
```python
def is_answer_correct(user_answer, correct_answer):
    # 1. Нормализация ответов
    user_norm = normalize_answer(user_answer)
    correct_norm = normalize_answer(correct_answer)
    
    # 2. Точное совпадение
    if user_norm == correct_norm:
        return True
    
    # 3. Высокая схожесть (85%+)
    if similarity >= 0.85:
        return True
    
    # 4. Полное содержание слова
    if user_norm in correct_norm or correct_norm in user_norm:
        return True
    
    # 5. Пересечение слов
    # 6. Схожесть отдельных слов
```

## 🎯 Особенности архитектуры

### ✅ **Преимущества**

1. **Модульность**: Четкое разделение слоев
2. **Масштабируемость**: Легко добавлять новые источники вопросов
3. **Надежность**: Обработка ошибок на всех уровнях
4. **Производительность**: Кэширование и предотвращение дублирования
5. **Гибкость**: Поддержка разных режимов игры

### 🔧 **Технические решения**

1. **Async/Await**: Неблокирующие операции
2. **Type Hints**: Строгая типизация
3. **Dataclasses**: Удобные модели данных
4. **Error Handling**: Декоратор `@safe_async_call`
5. **State Management**: Централизованное управление состоянием

### 📊 **Мониторинг качества**

1. **Предотвращение дублирования**: История вопросов в БД
2. **Валидация ответов**: Проверка структуры и содержания
3. **Фолбэки**: Запасные варианты при ошибках
4. **Логирование**: Детальные логи для отладки

## 🛠️ Улучшения в последних версиях

### 1. **Улучшенная логика ответов**
- Нечеткое сравнение с 85% точностью
- Поддержка частичных совпадений ("Реал" = "Реал Мадрид")
- Анализ пересечения слов

### 2. **Индивидуальное форматирование**
- Отдельные результаты для каждого участника
- Рейтинг по количеству правильных ответов
- Детализация по каждому вопросу

### 3. **Улучшенный UI**
- Унифицированные настройки
- Красивое отображение ответов списком
- Fallback для пустых комментариев

## 📈 Статистика использования

```python
# Таблицы статистики в БД:
questions_history  # История всех вопросов
games             # Завершенные игры
users             # Статистика пользователей
answers           # Детальные ответы
```

---

**Дата анализа:** 2025-07-10  
**Версия:** Quiz Bot 2.0  
**Статус:** ✅ Производственная архитектура